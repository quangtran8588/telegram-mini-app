import{ac as b,ad as d,ae as L,d as y,af as v}from"./index-CdW8WO0h.js";async function E(s,e){return await s({method:"eth_sendRawTransaction",params:[e]})}const O="/sdk/2022-08-12/embedded-wallet",h=s=>`thirdwebEwsWalletUserId-${s}`,A="walletToken",g=s=>`${A}-${s}`,S="a",p=(s,e)=>`${S}-${s}-${e}`,f=new Map;class I{constructor({clientId:e}){Object.defineProperty(this,"isSupported",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.isSupported=typeof window<"u"&&!!window.localStorage,this.clientId=e}async getItem(e){return this.isSupported?window.localStorage.getItem(e):f.get(e)??null}async setItem(e,t){if(this.isSupported)return window.localStorage.setItem(e,t);f.set(e,t)}async removeItem(e){const t=await this.getItem(e);return this.isSupported&&t?(window.localStorage.removeItem(e),!0):!1}async saveAuthCookie(e){await this.setItem(g(this.clientId),e)}async getAuthCookie(){return this.getItem(g(this.clientId))}async removeAuthCookie(){return this.removeItem(g(this.clientId))}async saveDeviceShare(e,t){await this.saveWalletUserId(t),await this.setItem(p(this.clientId,t),e)}async getDeviceShare(){const e=await this.getWalletUserId();return e?this.getItem(p(this.clientId,e)):null}async removeDeviceShare(){const e=await this.getWalletUserId();return e?this.removeItem(p(this.clientId,e)):!1}async getWalletUserId(){return this.getItem(h(this.clientId))}async saveWalletUserId(e){await this.setItem(h(this.clientId),e)}async removeWalletUserId(){return this.removeItem(h(this.clientId))}}function m(s){return new Promise(e=>{setTimeout(e,s*1e3)})}const W={height:"100%",width:"100%",border:"none",backgroundColor:"transparent",colorScheme:"light",position:"fixed",top:"0px",right:"0px",zIndex:"2147483646",display:"none"},w=new Map;class T{constructor({link:e,baseUrl:t,iframeId:i,container:a=document.body,onIframeInitialize:r}){Object.defineProperty(this,"iframe",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"POLLING_INTERVAL_SECONDS",{enumerable:!0,configurable:!0,writable:!0,value:1.4}),Object.defineProperty(this,"iframeBaseUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.iframeBaseUrl=t;let n=document.getElementById(i);const o=new URL(e);if(!n||n.src!==o.href){if(!n){n=document.createElement("iframe");const l={...W};Object.assign(n.style,l),n.setAttribute("id",i),n.setAttribute("fetchpriority","high"),a.appendChild(n)}n.src=o.href;const u=l=>{if(l.data.eventType==="ewsIframeLoaded"){if(window.removeEventListener("message",u),!n){console.warn("thirdweb Iframe not found");return}this.onIframeLoadHandler(n,r)()}};window.addEventListener("message",u)}this.iframe=n}async onIframeLoadedInitVariables(){return{}}onIframeLoadHandler(e,t){return async()=>{var n;const i=new MessageChannel,a=new Promise((o,u)=>{i.port1.onmessage=l=>{const{data:c}=l;i.port1.close(),c.success||u(new Error(c.error)),w.set(e.src,!0),t&&t(),o(!0)}});(n=e==null?void 0:e.contentWindow)==null||n.postMessage({eventType:"initIframe",data:await this.onIframeLoadedInitVariables()},this.iframeBaseUrl,[i.port2]),await a}}async call({procedureName:e,params:t,showIframe:i=!1}){var n;for(;!w.get(this.iframe.src);)await m(this.POLLING_INTERVAL_SECONDS);i&&(this.iframe.style.display="block",await m(.005));const a=new MessageChannel,r=new Promise((o,u)=>{a.port1.onmessage=async l=>{const{data:c}=l;a.port1.close(),i&&(await m(.1),this.iframe.style.display="none"),c.success?o(c.data):u(new Error(c.error))}});return(n=this.iframe.contentWindow)==null||n.postMessage({eventType:e,data:t},this.iframeBaseUrl,[a.port2]),r}destroy(){w.delete(this.iframe.src)}}class P extends T{constructor({clientId:e,baseUrl:t}){super({iframeId:N,link:_({clientId:e,path:O,baseUrl:t}).href,baseUrl:t,container:document.body}),Object.defineProperty(this,"clientId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.clientId=e}async onIframeLoadedInitVariables(){const e=new I({clientId:this.clientId});return{authCookie:await e.getAuthCookie(),deviceShareStored:await e.getDeviceShare(),walletUserId:await e.getWalletUserId(),clientId:this.clientId}}}function _({clientId:s,baseUrl:e,path:t,queryParams:i}){var r;const a=new URL(`${t}`,e);if(i)for(const n of Object.keys(i))a.searchParams.set(n,((r=i[n])==null?void 0:r.toString())||"");return a.searchParams.set("clientId",s),a}const N="thirdweb-in-app-wallet-iframe";class U{constructor({baseUrl:e,querier:t,preLogin:i,postLogin:a,client:r}){Object.defineProperty(this,"LoginQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"preLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"postLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"baseUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.baseUrl=e,this.LoginQuerier=t,this.preLogin=i,this.postLogin=a,this.client=r}async sendEmailLoginOtp({email:e}){return await this.preLogin(),await this.LoginQuerier.call({procedureName:"sendThirdwebEmailLoginOtp",params:{email:e}})}}class C extends U{constructor(){super(...arguments),Object.defineProperty(this,"closeWindow",{enumerable:!0,configurable:!0,writable:!0,value:({isWindowOpenedByFn:e,win:t,closeOpenedWindow:i})=>{e?t==null||t.close():t&&i?i(t):t&&t.close()}})}async getOauthLoginUrl(e){return await this.LoginQuerier.call({procedureName:"getHeadlessOauthLoginLink",params:{authProvider:e}})}async loginWithModal(){await this.preLogin();const e=await this.LoginQuerier.call({procedureName:"loginWithThirdwebModal",params:void 0,showIframe:!0});return this.postLogin(e)}async loginWithEmailOtp({email:e}){await this.preLogin();const t=await this.LoginQuerier.call({procedureName:"loginWithThirdwebModal",params:{email:e},showIframe:!0});return this.postLogin(t)}getOauthPopUpSizing(e){switch(e){case b.FACEBOOK:return"width=715, height=555";default:return"width=350, height=500"}}async loginWithOauth(e){let t=e==null?void 0:e.openedWindow,i=!1;if(t||(t=window.open("","Login",this.getOauthPopUpSizing(e.oauthProvider)),i=!0),!t)throw new Error("Something went wrong opening pop-up");const[{loginLink:a}]=await Promise.all([this.getOauthLoginUrl(e.oauthProvider),this.preLogin()]);t.location.href=a;const r=await new Promise((n,o)=>{const u=window.setInterval(async()=>{t&&t.closed&&(clearInterval(u),window.removeEventListener("message",l),o(new Error("User closed login window")))},1e3),l=async c=>{if(c.origin===this.baseUrl){if(typeof c.data!="object"){o(new Error("Invalid event data"));return}switch(c.data.eventType){case"userLoginSuccess":{window.removeEventListener("message",l),clearInterval(u),this.closeWindow({isWindowOpenedByFn:i,win:t,closeOpenedWindow:e==null?void 0:e.closeOpenedWindow}),c.data.authResult&&n(c.data.authResult);break}case"userLoginFailed":{window.removeEventListener("message",l),clearInterval(u),this.closeWindow({isWindowOpenedByFn:i,win:t,closeOpenedWindow:e==null?void 0:e.closeOpenedWindow}),o(new Error(c.data.error));break}case"injectDeveloperClientId":{t==null||t.postMessage({eventType:"injectDeveloperClientIdResult",developerClientId:this.client.clientId,authOption:e.oauthProvider},this.baseUrl);break}}}};window.addEventListener("message",l)});return this.postLogin({storedToken:{...r.storedToken,shouldStoreCookieString:!0},walletDetails:{...r.walletDetails,isIframeStorageEnabled:!1}})}async loginWithCustomJwt({encryptionKey:e,jwt:t}){await this.preLogin();const i=await this.LoginQuerier.call({procedureName:"loginWithCustomJwt",params:{encryptionKey:e,jwt:t}});return this.postLogin(i)}async loginWithCustomAuthEndpoint({encryptionKey:e,payload:t}){await this.preLogin();const i=await this.LoginQuerier.call({procedureName:"loginWithCustomAuthEndpoint",params:{encryptionKey:e,payload:t}});return this.postLogin(i)}async verifyEmailLoginOtp({email:e,otp:t,recoveryCode:i}){const a=await this.LoginQuerier.call({procedureName:"verifyThirdwebEmailLoginOtp",params:{email:e,otp:t,recoveryCode:i}});return this.postLogin(a)}}class D{constructor({client:e,querier:t,onAuthSuccess:i,baseUrl:a}){Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"AuthQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onAuthSuccess",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"BaseLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.client=e,this.AuthQuerier=t,this.localStorage=new I({clientId:e.clientId}),this.onAuthSuccess=i,this.BaseLogin=new C({postLogin:async r=>this.postLogin(r),preLogin:async()=>{await this.preLogin()},querier:t,client:e,baseUrl:a})}async preLogin(){await this.logout()}async postLogin({storedToken:e,walletDetails:t}){return e.shouldStoreCookieString&&await this.localStorage.saveAuthCookie(e.cookieString),await this.onAuthSuccess({storedToken:e,walletDetails:t})}async loginWithModal(){return this.BaseLogin.loginWithModal()}async loginWithEmailOtp(e){return this.BaseLogin.loginWithEmailOtp(e)}async loginWithCustomJwt(e){return this.BaseLogin.loginWithCustomJwt(e)}async loginWithCustomAuthEndpoint(e){return this.BaseLogin.loginWithCustomAuthEndpoint(e)}async loginWithOauth(e){return this.BaseLogin.loginWithOauth(e)}async sendEmailLoginOtp({email:e}){return this.BaseLogin.sendEmailLoginOtp({email:e})}async verifyEmailLoginOtp(e){return this.BaseLogin.verifyEmailLoginOtp(e)}async logout(){const{success:e}=await this.AuthQuerier.call({procedureName:"logout",params:void 0}),t=await this.localStorage.removeAuthCookie(),i=await this.localStorage.removeWalletUserId();return{success:e||t||i}}}class k{constructor({client:e,querier:t}){Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"walletManagerQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.client=e,this.walletManagerQuerier=t,this.localStorage=new I({clientId:e.clientId})}async postWalletSetUp({deviceShareStored:e,walletAddress:t,isIframeStorageEnabled:i,walletUserId:a}){return i||await this.localStorage.saveDeviceShare(e,a),{walletAddress:t}}async getUserWalletStatus(){const e=await this.walletManagerQuerier.call({procedureName:"getUserStatus",params:void 0});return e.status===d.LOGGED_IN_WALLET_INITIALIZED?{status:d.LOGGED_IN_WALLET_INITIALIZED,...e.user,wallet:this}:e.status===d.LOGGED_IN_NEW_DEVICE?{status:d.LOGGED_IN_WALLET_UNINITIALIZED,...e.user}:e.status===d.LOGGED_IN_WALLET_UNINITIALIZED?{status:d.LOGGED_IN_WALLET_UNINITIALIZED,...e.user}:{status:e.status}}async getAccount(){const e=this.walletManagerQuerier,{address:t}=await e.call({procedureName:"getAddress",params:void 0}),i=async r=>{const{signedTransaction:n}=await e.call({procedureName:"signTransaction",params:{transaction:{to:r.to??void 0,data:r.data,value:r.value,gasLimit:r.gas,gasPrice:r.gasPrice,nonce:r.nonce,chainId:r.chainId,accessList:r.accessList,maxFeePerGas:r.maxFeePerGas,maxPriorityFeePerGas:r.maxPriorityFeePerGas,type:r.maxFeePerGas?2:0},chainId:r.chainId,rpcEndpoint:`https://${r.chainId}.rpc.thirdweb.com`}});return n},a=this.client;return{address:t,async signTransaction(r){if(!r.chainId)throw new Error("chainId required in tx to sign");return i({...r,chainId:r.chainId})},async sendTransaction(r){const n=L({client:a,chain:y(r.chainId)}),o=await i(r);return{transactionHash:await E(n,o)}},async signMessage({message:r}){const n=typeof r=="string"?r:r.raw,{signedMessage:o}=await e.call({procedureName:"signMessage",params:{message:n,chainId:1}});return o},async signTypedData(r){var u,l;(u=r.types)!=null&&u.EIP712Domain&&(r.types.EIP712Domain=void 0);const n=Number(((l=r.domain)==null?void 0:l.chainId)||1),{signedTypedData:o}=await e.call({procedureName:"signTypedDataV4",params:{domain:r.domain,types:r.types,message:r.message,chainId:n,rpcEndpoint:`https://${n}.rpc.thirdweb.com`}});return o}}}}class G{isClientIdLegacyPaper(e){return e.indexOf("-")>0&&e.length===36}constructor({client:e,onAuthSuccess:t}){if(Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"querier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"wallet",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"auth",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.isClientIdLegacyPaper(e.clientId))throw new Error("You are using a legacy clientId. Please use the clientId found on the thirdweb dashboard settings page");const i=`https://${v().inAppWallet}`;this.client=e,this.querier=new P({clientId:e.clientId,baseUrl:i}),this.wallet=new k({client:e,querier:this.querier}),this.auth=new D({client:e,querier:this.querier,baseUrl:i,onAuthSuccess:async a=>(t==null||t(a),await this.wallet.postWalletSetUp({...a.walletDetails,walletUserId:a.storedToken.authDetails.userWalletId}),await this.querier.call({procedureName:"initIframe",params:{deviceShareStored:a.walletDetails.deviceShareStored,clientId:this.client.clientId,walletUserId:a.storedToken.authDetails.userWalletId,authCookie:a.storedToken.cookieString}}),{user:{status:d.LOGGED_IN_WALLET_INITIALIZED,authDetails:a.storedToken.authDetails,wallet:this.wallet,walletAddress:a.walletDetails.walletAddress}})})}async getUser(){return this.wallet.getUserWalletStatus()}}export{G as InAppWalletSdk};
